<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager - Mwaza Personal Website</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .login-button {
      background: #24292e;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 20px;
    }
    .login-button:hover {
      background: #1a1e22;
    }
    .debug {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #333;
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 9999;
      max-width: 300px;
    }
    .error {
      background: #d32f2f;
    }
    .success {
      background: #2e7d32;
    }
    .cms-container {
      display: none;
    }
  </style>
</head>
<body>
  <div class="debug" id="debug">
    Loading CMS script...
  </div>

  <div class="login-container" id="loginContainer">
    <h2>Content Manager</h2>
    <p>Login with GitHub to manage your website content</p>
    <a href="#" class="login-button" id="loginButton">Login with GitHub</a>
  </div>

  <div class="cms-container" id="cmsContainer">
    <!-- CMS will be loaded here -->
  </div>
  
  <script>
    function updateDebug(message, type = '') {
      const debugEl = document.getElementById('debug');
      debugEl.textContent = message;
      debugEl.className = 'debug ' + type;
      console.log('Debug:', message);
    }

    // Check if user is already authenticated
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');

    if (code && state) {
      // User is returning from GitHub OAuth
      updateDebug('Processing GitHub OAuth callback...');
      processOAuthCallback(code, state);
    } else {
      // Show login page
      updateDebug('Showing login page');
      setupLoginButton();
    }

    function setupLoginButton() {
      const loginButton = document.getElementById('loginButton');
      loginButton.addEventListener('click', function(e) {
        e.preventDefault();
        updateDebug('Redirecting to GitHub OAuth...');
        
        // Generate random state for security
        const state = Math.random().toString(36).substring(7);
        localStorage.setItem('oauth_state', state);
        
        // Redirect to GitHub OAuth
        const clientId = 'Ov23liu2ilyXCHE9mSqe';
        const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
        const scope = 'repo';
        
        const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&state=${state}`;
        
        window.location.href = authUrl;
      });
    }

    function processOAuthCallback(code, state) {
      // Verify state parameter
      const storedState = localStorage.getItem('oauth_state');
      if (state !== storedState) {
        updateDebug('Invalid OAuth state', 'error');
        return;
      }

      updateDebug('OAuth callback received, loading CMS...');
      
      // Hide login container and show CMS
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('cmsContainer').style.display = 'block';
      
      // Store the access token (simplified for demo)
      localStorage.setItem('github_token', code);
      
      // Load CMS
      loadCMS();
    }

    function loadCMS() {
      // Load Netlify CMS
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js';
      script.onload = function() {
        console.log('Netlify CMS script loaded');
        updateDebug('Script loaded, initializing CMS...');
        
        setTimeout(() => {
          if (typeof CMS !== 'undefined') {
            console.log('CMS found!', CMS);
            updateDebug('CMS found, initializing...');
            
            try {
              // Initialize CMS with custom configuration that bypasses Netlify auth
              CMS.init({
                config: {
                  backend: {
                    name: 'github',
                    repo: 'mwazakd/mwazakd.github.io',
                    branch: 'main',
                    auth_type: 'implicit'
                  },
                  media_folder: 'assets/uploads',
                  public_folder: '/assets/uploads',
                  site_url: 'https://mwazakd.github.io',
                  logo_url: '/assets/images/profile.jpg',
                  collections: [
                    {
                      name: 'blog',
                      label: 'Blog Posts',
                      folder: '_posts',
                      create: true,
                      slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
                      fields: [
                        {label: 'Title', name: 'title', widget: 'string'},
                        {label: 'Publish Date', name: 'date', widget: 'datetime'},
                        {label: 'Image', name: 'image', widget: 'image'},
                        {label: 'Body', name: 'body', widget: 'markdown'}
                      ]
                    },
                    {
                      name: 'pages',
                      label: 'Pages',
                      files: [
                        {
                          label: 'Home Page',
                          name: 'home',
                          file: 'index.md',
                          fields: [
                            {label: 'Title', name: 'title', widget: 'string'},
                            {label: 'Body', name: 'body', widget: 'markdown'}
                          ]
                        },
                        {
                          label: 'Research',
                          name: 'research',
                          file: 'research.md',
                          fields: [
                            {label: 'Title', name: 'title', widget: 'string'},
                            {label: 'Body', name: 'body', widget: 'markdown'}
                          ]
                        },
                        {
                          label: 'Teaching',
                          name: 'teaching',
                          file: 'teaching.md',
                          fields: [
                            {label: 'Title', name: 'title', widget: 'string'},
                            {label: 'Body', name: 'body', widget: 'markdown'}
                          ]
                        },
                        {
                          label: 'Hobbies',
                          name: 'hobbies',
                          file: 'hobbies.md',
                          fields: [
                            {label: 'Title', name: 'title', widget: 'string'},
                            {label: 'Body', name: 'body', widget: 'markdown'}
                          ]
                        },
                        {
                          label: 'Links',
                          name: 'links',
                          file: 'links.md',
                          fields: [
                            {label: 'Title', name: 'title', widget: 'string'},
                            {label: 'Body', name: 'body', widget: 'markdown'}
                          ]
                        }
                      ]
                    },
                    {
                      name: 'gallery',
                      label: 'Gallery',
                      folder: 'gallery',
                      create: true,
                      slug: '{{slug}}',
                      fields: [
                        {label: 'Title', name: 'title', widget: 'string'},
                        {label: 'Image', name: 'image', widget: 'image'}
                      ]
                    }
                  ]
                }
              });
              
              console.log('CMS initialized successfully');
              updateDebug('CMS initialized successfully!', 'success');
            } catch (error) {
              console.error('CMS initialization failed:', error);
              updateDebug('CMS init failed: ' + error.message, 'error');
            }
          } else {
            updateDebug('CMS object not found', 'error');
          }
        }, 1000);
      };
      script.onerror = function() {
        console.error('Failed to load Netlify CMS script');
        updateDebug('Failed to load CMS script', 'error');
      };
      
      document.head.appendChild(script);
    }
  </script>
</body>
</html>